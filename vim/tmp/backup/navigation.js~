//Authentication
$( document ).delegate("#authentication", "pageinit", function() {
    console.log("authentication");
    var email = window.localStorage.getItem("email"); 
    var password= window.localStorage.getItem("password"); 
    if (email ===""){
    $("#login").click(function(e) {
        console.log("login");
        window.localStorage.setItem("email",$("#email").val());
        window.localStorage.setItem("password",$("#email").val());
        $.mobile.changePage('#start', { transition: "slide"} );
    });
    }
    else {
        $.mobile.changePage('#start', { transition: "slide"} );
    }

});
//Start
$( document ).delegate("#start", "pageinit", function() {
    $("#logout").click(function(e) {
        window.localStorage.setItem("email","");
        window.localStorage.setItem("password","");
        $.mobile.changePage('#authentication', { transition: "slide"} );
    });
});
//Busstation

$( document ).delegate("#station", "pageinit", function() {
    nfc.addTagDiscoveredListener(onNfc, success, failure);
    $("#station_cancel").click(function(e) {
        $.mobile.changePage('#start', { transition: "slide"} );
    });
    $("#station_next").click(function(e) {
        $.mobile.changePage('#map', { transition: "slide"} );
    });
});
//Tag
$( document ).delegate("#tag", "pageinit", function() {
    $("#tag_add").click(function(e) {
        var tag={};
        tag.code=tagId;
        tag.position_id=$("#position").val();
        tags.push(tag);
        $.mobile.changePage('#station', { transition: "slide"} );
    });
});
$( document ).delegate("#map", "pageinit", function() {
    $("#map_cancel").click(function(e) {
        $.mobile.changePage('#start', { transition: "slide"} );
    });
    $("#station_save").click(function(e) {
        console.log("Busstations:"+busstations);
        busstations[cBusstation].tags=tags
        console.log(JSON.stringify(busstations[cBusstation]));
    $.ajax({
        'beforeSend': function(xhr) {
            //May need to use "Authorization" instead
            xhr.setRequestHeader("Authorization",
                "Basic " + btoa("mobias:secret"));
        },

        url: "http://sheltered-everglades-9379.herokuapp.com/api/mastens/"+cBusstation,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(busstations[cBusstation]),
    });
    $.mobile.changePage('#start', { transition: "slide"} );
    tags=[];
    });
});


$( document ).delegate("#start", "pagebeforeshow", function() {
    tags=[];
    cBusstation=null;
    busstations=[];
}); 
$( document ).delegate("#tag", "pagebeforeshow", function() {
    $('#tagId').val(tagId);
}); 
$( document ).delegate("#station", "pagebeforeshow", function() {
    var output = '';
    $.each(tags, function(index, value){
        output += '<li>TagId: '+value.code+', Position: '+positions[value.position_id].name+'</li>';
    });
    $('#tags').empty().append(output).listview('refresh');
});

$( document ).delegate("#map", "pagehide", function() {
    console.log("gggggggggggggggggggg");
});
$( document ).delegate("#map", "pagebeforeshow", function() {
    mapInit();
});
var tags=[];
var tagId;
function onNfc(nfcEvent) {
    activePage = $.mobile.activePage.attr("id");
    console.log(activePage);
    if (activePage==="station") {
        tagId=nfcEvent.tag.id;
        $.mobile.changePage("#tag",{transition: "pop",role: "dialog"});
    }
}
function success(result) {
    console.log("Listening for NFC Messages");
}
 
function failure(reason) {
    alert("Failed to add NDEF listener");
}
